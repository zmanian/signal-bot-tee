version: "3.8"

services:
  signal-api:
    # Pinned to specific digest for TEE attestation integrity
    # To update: docker pull bbernhard/signal-cli-rest-api:latest && docker inspect --format='{{index .RepoDigests 0}}'
    image: bbernhard/signal-cli-rest-api@sha256:04ee57f9819a90c89fbee46f74e080a032f5f05decf6e4b4a4e1f45d050ed9c8
    container_name: signal-api
    environment:
      - MODE=normal
      - AUTO_RECEIVE_SCHEDULE=
      - LOG_LEVEL=info
    volumes:
      - /var/run/dstack.sock:/var/run/dstack.sock:ro
      - signal-config:/home/.local/share/signal-cli
    # SECURITY: No ports exposed - only accessible within Docker network
    # For initial setup, use: docker exec signal-api curl ...
    networks:
      - internal
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped

  signal-bot:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: signal-bot
    environment:
      - SIGNAL__SERVICE_URL=http://signal-api:8080
      - SIGNAL__PHONE_NUMBER=${SIGNAL_PHONE}
      - NEAR_AI__API_KEY=${NEAR_AI_API_KEY}
      - NEAR_AI__BASE_URL=${NEAR_AI_BASE_URL:-https://cloud-api.near.ai/v1}
      - NEAR_AI__MODEL=${NEAR_AI_MODEL:-deepseek-ai/DeepSeek-V3.1}
      - CONVERSATION__MAX_MESSAGES=${CONVERSATION_MAX_MESSAGES:-50}
      - CONVERSATION__TTL=${CONVERSATION_TTL:-24h}
      - BOT__LOG_LEVEL=${LOG_LEVEL:-info}
      - DSTACK__SOCKET_PATH=/var/run/dstack.sock
    volumes:
      - /var/run/dstack.sock:/var/run/dstack.sock:ro
    networks:
      - internal
    depends_on:
      signal-api:
        condition: service_healthy
    restart: unless-stopped

  signal-registration-proxy:
    build:
      context: ..
      dockerfile: docker/Dockerfile.proxy
    container_name: signal-registration-proxy
    environment:
      - SIGNAL__API_URL=http://signal-api:8080
      - REGISTRY__PATH=/data/registry.enc
      - SERVER__LISTEN_ADDR=0.0.0.0
      - SERVER__PORT=8081
      - DSTACK__SOCKET_PATH=/var/run/dstack.sock
      - RATE_LIMIT__GLOBAL_PER_MINUTE=${RATE_LIMIT_GLOBAL_PER_MINUTE:-10}
      - RATE_LIMIT__PER_NUMBER_PER_HOUR=${RATE_LIMIT_PER_NUMBER_PER_HOUR:-3}
      - LOG__LEVEL=${LOG_LEVEL:-info}
    volumes:
      - /var/run/dstack.sock:/var/run/dstack.sock:ro
      - registry-data:/data
    ports:
      # Expose registration API externally (for multi-tenant self-service)
      - "8081:8081"
    networks:
      - internal
    depends_on:
      signal-api:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8081/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped

volumes:
  signal-config:
    driver: local
  registry-data:
    driver: local

networks:
  internal:
    # Internal network - no external access to signal-api
    name: signal-bot-internal
