# Phala Cloud TEE Deployment Configuration
# Deploy with: phala cvms create --name signal-bot-tee --compose ./phala-compose.yaml --vcpu 2 --memory 4096 --disk-size 20

services:
  signal-api:
    # Pinned to specific digest for TEE attestation integrity
    image: bbernhard/signal-cli-rest-api@sha256:04ee57f9819a90c89fbee46f74e080a032f5f05decf6e4b4a4e1f45d050ed9c8
    container_name: signal-api
    environment:
      - MODE=normal
      # Receive messages every minute (5-field cron format)
      - AUTO_RECEIVE_SCHEDULE=* * * * *
      - LOG_LEVEL=info
    # Port closed - signal-api only accessible internally
    volumes:
      - signal-config-v3:/home/.local/share/signal-cli
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped

  signal-bot:
    # Image hosted on Docker Hub
    image: zaki1iqlusion/signal-bot-tee:latest
    container_name: signal-bot
    environment:
      # Signal configuration - polls ALL registered accounts automatically
      - SIGNAL__SERVICE_URL=http://signal-api:8080
      # NEAR AI configuration - secrets encrypted by Phala
      - NEAR_AI__API_KEY=${NEAR_AI_API_KEY}
      - NEAR_AI__BASE_URL=${NEAR_AI_BASE_URL:-https://cloud-api.near.ai/v1}
      - NEAR_AI__MODEL=${NEAR_AI_MODEL:-deepseek-ai/DeepSeek-V3.1}
      # Conversation settings
      - CONVERSATION__MAX_MESSAGES=${CONVERSATION_MAX_MESSAGES:-50}
      - CONVERSATION__TTL=${CONVERSATION_TTL:-24h}
      # Bot settings
      - BOT__LOG_LEVEL=${LOG_LEVEL:-info}
      # Dstack TEE socket - provided by Phala CVM
      - DSTACK__SOCKET_PATH=/var/run/dstack.sock
    volumes:
      # Dstack socket for TEE attestation (provided by Phala CVM)
      - /var/run/dstack.sock:/var/run/dstack.sock:ro
    depends_on:
      - signal-api
    restart: unless-stopped

  signal-registration-proxy:
    # Image hosted on Docker Hub
    image: zaki1iqlusion/signal-registration-proxy:v0.6.0
    container_name: signal-registration-proxy
    environment:
      # Signal API (internal)
      - SIGNAL__API_URL=http://signal-api:8080
      # Registry storage
      - REGISTRY__PATH=/data/registry.enc
      # Server settings
      - SERVER__LISTEN_ADDR=0.0.0.0
      - SERVER__PORT=8081
      # Dstack TEE socket - provided by Phala CVM
      - DSTACK__SOCKET_PATH=/var/run/dstack.sock
      # Rate limiting
      - RATE_LIMIT__GLOBAL_PER_MINUTE=${RATE_LIMIT_GLOBAL_PER_MINUTE:-10}
      - RATE_LIMIT__PER_NUMBER_PER_HOUR=${RATE_LIMIT_PER_NUMBER_PER_HOUR:-3}
      # Logging
      - LOG__LEVEL=${LOG_LEVEL:-info}
    volumes:
      # Dstack socket for TEE attestation and key derivation
      - /var/run/dstack.sock:/var/run/dstack.sock:ro
      # Encrypted registry persistence
      - registry-data:/data
    ports:
      # Expose registration API externally
      - "8081:8081"
    depends_on:
      - signal-api
    restart: unless-stopped

volumes:
  signal-config-v3:
    driver: local
  registry-data:
    driver: local
